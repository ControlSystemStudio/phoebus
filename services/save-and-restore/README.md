# Save and restore service

The save-and-restore service implements service as a collection
of REST endpoints. These can be used by clients to manage configurations (aka save sets) and
snapshots, to compare snapshots and to restore PV values from snapshots.

The service is packaged as a self-contained Spring Boot jar file. External dependencies are limited to a JVM (Java 17+)
and a running instance of Elasticsearch (8.x).

# Build

Build the Phoebus product. The jar file generated by default in the target directory of the save and restore service module
is a self-contained Spring Boot executable. It includes Tomcat dependencies and should
hence not be deployed to an external web application server.

To convert the build artifact to a war file for
deployment to an application server, see https://spring.io/guides/gs/convert-jar-to-war/

# Run

Run the service like so:

`java [options] -jar service-save-and-restore-<version>.jar`

Where [options] may override default values for Elasticsearch host (localhost) and port (9200):

-Delasticsearch.network.host=[host]  
-Delasticsearch.http.port=[port]

or you can use a `.properties file`

`java -Dspring.config.location=/path/to/save_restore.properties -jar service-save-and-restore-<version>.jar`

# Verification

To check that the server is running correctly.

```
$ curl --fail-with-body http://localhost:8080/save-restore/
{
  "name" : "service-save-and-restore",
  "version" : "4.7.4-SNAPSHOT",
  "elastic" : {
    "status" : "Connected",
    "clusterName" : "elastic-nasa",
    "clusterUuid" : "QNeYpFlWRueYPH3uXGUiGw",
    "version" : "co.elastic.clients.elasticsearch._types.ElasticsearchVersionInfo@3d95cef6"
  },
  "rootNodeID" : "44bef5de-e8e6-4014-af37-b8f6c8a939a2"
}
```

The response will have information about the service version, the root node id, the status of the connection with the elastic backend.

# Documentation

Details about the REST API is found in the Phoebus bundled help content, which is pulled from the doc/index.rst file.

# Docker

The latest version of the service is available as a Docker image (ghcr.io/controlsystemstudio/phoebus/service-save-and-restore:master). Pushes to the master branch into this directory will trigger a new build of the image.

Docker compose files are provided. These depend on the environment variables as described below.

1. ```docker-compose.yml```. Use this to launch both Elasticsearch and the service. The environment variable ```HOST_IP_ADDRESS``` 
    should be set to the host's external IP address (i.e. **not** 127.0.0.1 or localhost).
2. ```docker-compose-save-and-restore.yml```. Use this to launch save-and-restore service only. The environment variable ```HOST_IP_ADDRESS```
   should be set to the host's external IP address (i.e. **not** 127.0.0.1 or localhost), while the environment variable ```ELASTIC_HOST``` should
   be set to the IP address of the Elasticsearch host. If Elasticsearch is running on  localhost, please specify the host's
   external IP address.

Docker supports environment variables to be set in a file (default ```.env``` in current directory) like so:

```HOST_IP_ADDRESS=1.2.3.4```  
```ELASTIC_HOST=1.2.3.4```  
.  
.  
.

This may be preferable compared to setting environment variables on command line, e.g.

```>export HOST_IP_ADDRESS=1.2.3.4```.

**NOTE:** Accessing IOCs over pva (default mode in the Docker compose files) works **only** if IOC is running on the
same host as the Docker container. Moreover, this has been verified to work only on Linux.